<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro:bit Runner Dashboard</title>
    <style>
        :root {
            --primary: #4e73df;
            --success: #1cc88a;
            --dark: #5a5c69;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f8f9fc; 
            margin: 0; padding: 20px; color: var(--dark);
        }
        .container { max-width: 500px; margin: auto; }
        .card { 
            background: white; border-radius: 15px; padding: 25px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); text-align: center;
            margin-bottom: 20px;
        }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .stat-box { background: #f1f3f9; padding: 15px; border-radius: 10px; }
        .value { font-size: 1.8em; font-weight: bold; color: var(--primary); display: block; }
        .label { font-size: 0.8em; color: #858796; text-transform: uppercase; }
        
        input[type="number"] {
            width: 80px; padding: 5px; border-radius: 5px; border: 1px solid #ddd; text-align: center;
        }
        button { 
            background: var(--primary); color: white; border: none; 
            padding: 12px 25px; border-radius: 30px; cursor: pointer; 
            font-size: 16px; font-weight: bold; transition: 0.3s; width: 100%;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(78,115,223,0.3); }
        .history { font-size: 0.9em; color: #666; margin-top: 20px; text-align: left; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2 style="margin-top:0">üëü Micro:bit Sync</h2>
        <p>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏±‡∏ß: <input type="number" id="weight" value="60" onchange="saveWeight()"> kg</p>
        <button onclick="connectBluetooth()">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        
        <div style="margin-top: 30px;">
            <span class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡πâ‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
            <span id="steps" class="value" style="font-size: 4em;">0</span>
        </div>

        <div class="stat-grid">
            <div class="stat-box">
                <span class="label">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</span>
                <span id="distance" class="value">0.00</span>
            </div>
            <div class="stat-box">
                <span class="label">‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç (kcal)</span>
                <span id="calories" class="value">0.00</span>
            </div>
        </div>
    </div>

    <div class="card history" id="history-box">
        <strong>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> <span id="last-sync">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
    </div>
</div>



<script>
    let weightInput = document.getElementById('weight');
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
    window.onload = () => {
        if(localStorage.getItem('userWeight')) {
            weightInput.value = localStorage.getItem('userWeight');
        }
        loadLastSession();
    };

    function saveWeight() {
        localStorage.setItem('userWeight', weightInput.value);
    }

    async function connectBluetooth() {
        const UART_SERVICE = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const UART_TX = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'BBC micro:bit' }],
                optionalServices: [UART_SERVICE]
            });

            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(UART_SERVICE);
            const characteristic = await service.getCharacteristic(UART_TX);

            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', (e) => {
                let val = new TextDecoder().decode(e.target.value);
                processData(parseInt(val));
            });
            
            alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
        } catch (err) { console.log(err); }
    }

    function processData(steps) {
        if (isNaN(steps)) return;

        let weight = parseFloat(weightInput.value);
        let dist = (steps * 0.75) / 1000; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏°‡∏ï‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£
        let cals = steps * 0.0005 * weight; // ‡∏™‡∏π‡∏ï‡∏£‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏±‡∏ß

        document.getElementById('steps').innerText = steps.toLocaleString();
        document.getElementById('distance').innerText = dist.toFixed(2);
        document.getElementById('calories').innerText = cals.toFixed(2);

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á LocalStorage
        const session = {
            steps: steps,
            dist: dist.toFixed(2),
            cals: cals.toFixed(2),
            time: new Date().toLocaleString()
        };
        localStorage.setItem('lastSession', JSON.stringify(session));
        loadLastSession();
    }

    function loadLastSession() {
        const data = localStorage.getItem('lastSession');
        if(data) {
            const session = JSON.parse(data);
            document.getElementById('last-sync').innerText = `${session.time} (${session.steps} ‡∏Å‡πâ‡∏≤‡∏ß)`;
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            document.getElementById('steps').innerText = session.steps.toLocaleString();
            document.getElementById('distance').innerText = session.dist;
            document.getElementById('calories').innerText = session.cals;
        }
    }
</script>
</body>
</html>
