<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro:bit Runner Stable</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; text-align: center; padding: 20px; }
        .card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        .step-display { font-size: 4.5rem; font-weight: bold; color: #007bff; margin: 15px 0; }
        button { background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 1rem; cursor: pointer; width: 100%; }
        button:disabled { background: #ccc; }
        #status { margin-top: 15px; font-size: 0.85rem; color: #666; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>üëü Pedometer Sync</h2>
    <button id="connectBtn" onclick="connectBluetooth()">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Micro:bit</button>
    <div class="step-display" id="display-steps">0</div>
    <div id="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
    <div style="margin-top: 15px; font-size: 0.9rem; color: #444;">
        ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: <span id="display-dist">0.00</span> ‡∏Å‡∏°. | ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà: <span id="display-cal">0.00</span>
    </div>
</div>

<script>
    let bluetoothDevice;
    let uartChar;

    async function connectBluetooth() {
        const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const TX_CHAR_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

        try {
            document.getElementById('status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...";
            bluetoothDevice = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'BBC micro:bit' }],
                optionalServices: [SERVICE_UUID]
            });

            document.getElementById('status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ GATT Server...";
            const server = await bluetoothDevice.gatt.connect();

            // *** ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ GATT Error: ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Server ‡∏û‡∏£‡πâ‡∏≠‡∏° ***
            await new Promise(resolve => setTimeout(resolve, 1000));

            document.getElementById('status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Service...";
            const service = await server.getPrimaryService(SERVICE_UUID);
            uartChar = await service.getCharacteristic(TX_CHAR_UUID);

            await uartChar.startNotifications();
            uartChar.addEventListener('characteristicvaluechanged', handleData);
            
            document.getElementById('status').innerText = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
            document.getElementById('status').style.color = "green";
            document.getElementById('connectBtn').disabled = true;

        } catch (error) {
            console.error(error);
            document.getElementById('status').innerText = "‚ùå ‡∏´‡∏•‡∏∏‡∏î/‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + error.message;
            document.getElementById('status').style.color = "red";
        }
    }

    function handleData(event) {
        let decoder = new TextDecoder('utf-8');
        let rawData = decoder.decode(event.target.value).trim();
        let steps = parseInt(rawData);

        if (!isNaN(steps)) {
            document.getElementById('display-steps').innerText = steps.toLocaleString();
            document.getElementById('display-dist').innerText = ((steps * 0.75) / 1000).toFixed(2);
            document.getElementById('display-cal').innerText = (steps * 0.04).toFixed(2);
        }
    }
</script>
</body>
</html>
